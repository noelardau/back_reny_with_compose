version: '3.8'

services:
  # ========================================
  # POSTGRESQL
  # ========================================
  postgres:
    image: postgres:16-alpine
    container_name: postgres-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: renydb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    command: postgres -c log_statement=all
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d renydb"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # ========================================
  # SERVICE D'INITIALISATION / MIGRATION √Ä CHAUD
  # Ex√©cute tous les .sql du dossier ./sql √† chaque d√©marrage
  # ========================================
  postgres-init:
    image: postgres:16-alpine
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./sql:/sql:ro    
    profiles: ["init_db"]            # ‚Üê Cr√©e ce dossier et mets-y tous tes scripts
    environment:
      PGPASSWORD: admin
    command: >
      bash -c "
        echo '‚è≥ Attente que PostgreSQL soit pr√™t...'
        until pg_isready -h postgres -U admin -d renydb -q; do
          sleep 2
        done

        echo '‚úÖ PostgreSQL pr√™t ! Ex√©cution des scripts du dossier /sql ...'
        for file in /sql/*.sql; do
          if [[ -f "$$file" ]]; then
            echo \"‚û°Ô∏è  Ex√©cution de $(basename $$file)\"
            psql -h postgres -U admin -d renydb -f \"$$file\"
            echo \"‚úîÔ∏è  $(basename $$file) termin√©\"
          fi
        done

        echo 'üéâ Tous les scripts SQL ont √©t√© ex√©cut√©s !'
      "

  # ========================================
  # PGADMIN
  # ========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "8081:80"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
      - ./pgadmin-servers.json:/pgadmin4/servers.json:ro

  # ========================================
  # BACKEND GO
  # ========================================
  backend:
    image: golang:trixie   # 1.25.4 n‚Äôexiste pas encore, 1.23 est la derni√®re stable
    container_name: go-backend
    restart: unless-stopped
    depends_on:
      - postgres
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: admin
      DB_PASSWORD: admin
      DB_NAME: renydb
      DB_SSLMODE: disable
      SERVER_PORT: 3000
    ports:
      - "3000:3000"
    volumes:
      - .:/app
    working_dir: /app
    command: ["go", "run", "main.go"]

  # ========================================
  # FRONTS (inchang√©s)
  # ========================================
  backoffice:
    build:
      context: ./backoffice
      dockerfile: Dockerfile
    container_name: backoffice
    restart: unless-stopped
    develop:
      watch:
        - action: rebuild
          path: ./backoffice
          target: /app
    depends_on:
      - backend
    ports:
      - "3001:3000"
    environment:
      NODE_ENV: production

  vitrine:
    build:
      context: ./vitrine
      dockerfile: Dockerfile
    container_name: vitrine
    restart: unless-stopped
    develop:
      watch:
        - action: rebuild
          path: ./vitrine
          target: /app
    depends_on:
      - backend
    ports:
      - "3002:3000"
    environment:
      NODE_ENV: production

volumes:
  postgres-data:
    driver: local
  pgadmin-data:
    driver: local